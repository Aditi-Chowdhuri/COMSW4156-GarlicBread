name: Includify Continuous Integration


on:
 push:
   branches:
     - main
 pull_request:
   branches:
     - main


jobs:
 build:
   runs-on: ubuntu-latest


   steps:
     - name: Checkout code
       uses: actions/checkout@v4


     - name: Set up Java 17
       uses: actions/setup-java@v4
       with:
         java-version: '17'
         distribution: 'temurin'
         cache: maven


     - name: Build with Maven
       run: mvn clean install


     - name: Run tests
       run: mvn test


     - name: Run JaCoCo Coverage
       run: mvn jacoco:report


     - name: Check Checkstyle Violations
       run: mvn checkstyle:checkstyle


     - name: Create Reports Directory
       run: mkdir -p Reports


     - name: Move JaCoCo Report to Reports Directory
       run: cp target/site/jacoco/index.html Reports/jacoco-report.html


     - name: Move Checkstyle Report to Reports Directory
       run: cp target/site/checkstyle.html Reports/checkstyle-report.html


     - name: Upload Reports as Artifacts
       uses: actions/upload-artifact@v4
       with:
         name: reports
         path: Reports/


 newman:
   runs-on: ubuntu-latest


   steps:
     - name: Checkout code
       uses: actions/checkout@v4


     - name: Set up Node.js
       uses: actions/setup-node@v4
       with:
         node-version: '16'


     - name: Install Newman
       run: npm install -g newman


     - name: Run Newman Collection
       run: |
         newman run Includify.postman_collection.json \
          --reporters cli,html,json \
          --reporter-html-export newman-report.html \
          --reporter-json-export newman-report.json


     - name: Create Newman Reports Directory
       run: mkdir -p NewmanReports


     - name: Move Newman Reports to Directory
       run: |
         mv newman-report.html NewmanReports/
        mv newman-report.json NewmanReports/


     - name: Upload Newman Reports as Artifacts
       uses: actions/upload-artifact@v4
       with:
         name: newman-reports
         path: NewmanReports/


#TODO
#      - name: Commit Reports to Repository
#        run: |
#          git config --global user.name "github-actions"
#          git config --global user.email "github-actions@github.com"
#          git checkout -b ${{ github.head_ref }} || git checkout ${{ github.head_ref }}
#          git add Reports/*
#          git commit -m "Add all reports to Reports directory"
#          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:${{ github.head_ref }}
